# How To Find These???

find_program( GENCPP_BIN genmsg_cpp.py )

message(STATUS "GENCPP_BIN found at ${GENCPP_BIN}")

macro(generate_msg_cpp PKG)
  parse_arguments(PKG "MESSAGES;DEPENDENCIES" "" ${ARGN})
  
  message(">> generate_msg_cpp << PKG: ${PKG} MSGS: ${PKG_MESSAGES}  DEPNDS: ${PKG_DEPENDENCIES}")
  set(ALL_GEN_OUTPUT_FILES "")
  foreach(msg ${PKG_MESSAGES})
    
    # common stuff
    get_filename_component(MSG_SHORT_NAME ${msg} NAME_WE)
    set(MSG_INPUT_FILE ${CMAKE_CURRENT_BINARY_DIR}/${msg})
    message(STATUS "InputFile=${MSG_INPUT_FILE}")

    # Needed?
    #configure_file(${TOP}/${PKG}/msg/${MSGPATH}
    #  ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_FILES_DIRECTORY}/${MSGPATH}.stamp
    #  )

    set(MSG_GENERATED_NAME ${MSG_SHORT_NAME}.h)
    list(APPEND GENERATED_ALL ${MSG_GENERATED_NAME})

    set(GEN_OUTPUT_DIR ${CMAKE_BINARY_DIR}/gen_msgs/include/${PKG})
    set(GEN_OUTPUT_FILE ${GEN_OUTPUT_DIR}/${MSG_GENERATED_NAME})
    message(STATUS "GenOutputFile=${GEN_OUTPUT_FILE}")

    # Common, build deps
    set(IFLAGS "")
    set(DEP_TARGETS "")

#     foreach(dep ${PKG_DEPENDENCIES})
#       set(IFLAGS -I${dep}:${TOP}/${dep}/msg ${IFLAGS})

#     endforeach()


#     set(THESEDEPS "")
#     execute_process(COMMAND
#       ${GENCPP_EXE} ${INPUT_FULLPATH} -d ${IFLAGS}
#       OUTPUT_VARIABLE THESEDEPS
#       OUTPUT_STRIP_TRAILING_WHITESPACE
#       )
#     separate_arguments(THESEDEPS UNIX_COMMAND ${THESEDEPS})
#     show(THESEDEPS)

    foreach(dep ${PKG_DEPENDENCIES})
      list(APPEND DEP_TARGETS ${dep}_gencpp)
    endforeach()

    add_custom_command(OUTPUT ${GEN_OUTPUT_FILE}
       DEPENDS ${GENCPP_BIN} ${MSG_INPUT_FILE}# ${THESEDEPS}
       COMMAND ${GENCPP_BIN} ${MSG_INPUT_FILE}
       -p ${PKG}
       -o ${GEN_OUTPUT_DIR}
       ${IFLAGS}
       COMMENT "Generating C++ code from ${PKG}/${SHORTNAME}"
       )
     list(APPEND ALL_GEN_OUTPUT_FILES ${GEN_OUTPUT_FILE})

  endforeach() #msg
  message(STATUS "All Outputs: ${ALL_GEN_OUTPUT_FILES}")

  add_custom_target(${PKG}_gencpp
    DEPENDS ${ALL_GEN_OUTPUT_FILES}
    )

#  show(DEP_TARGETS)
#  if(DEP_TARGETS)
#    add_dependencies(${PKG}_gencpp ${DEP_TARGETS})
#  endif(DEP_TARGETS)

endmacro()